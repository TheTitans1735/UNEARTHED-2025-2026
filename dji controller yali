import pygame
import cv2
import os
from djitellopy import Tello
from datetime import datetime

#ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶
# ×¡×™×›×•× ××§×©×™× ğŸ®
# ××§×©	×¤×¢×•×œ×”:
# W / S	×§×“×™××” / ××—×•×¨×”
# A / D	×©×××œ×” / ×™××™× ×”
# â†‘ / â†“	×¢×œ×™×™×” / ×™×¨×™×“×”
# â† / â†’	×¡×™×‘×•×‘
# P	ğŸ“¸ ×¦×™×œ×•× ×ª××•× ×”
# ESC	ğŸ”´ × ×—×™×ª×” ×•×™×¦×™××”
#ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶ğŸ¶


# ---------- ×”×’×“×¨×•×ª ----------
SPEED = 50
IMAGE_DIR = "photos"

# ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×œ×ª××•× ×•×ª
os.makedirs(IMAGE_DIR, exist_ok=True)

# ---------- ××ª×—×•×œ ----------
pygame.init()
screen = pygame.display.set_mode((400, 300))
pygame.display.set_caption("DJI Tello Controller")

tello = Tello()
tello.connect()
print("Battery:", tello.get_battery(), "%")

tello.streamon()
frame_read = tello.get_frame_read()

tello.takeoff()
print("Takeoff")

clock = pygame.time.Clock()
running = True

# ---------- ×œ×•×œ××ª ×©×œ×™×˜×” ----------
while running:
    clock.tick(30)

    for event in pygame.event.get():
        # ×¡×’×™×¨×ª ×—×œ×•×Ÿ
        if event.type == pygame.QUIT:
            running = False

        # ××§×© ESC â€“ × ×—×™×ª×” ××™×™×“×™×ª
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_ESCAPE:
                print("Emergency land")
                tello.land()
                running = False

            # ××§×© P â€“ ×¦×™×œ×•× ×ª××•× ×”
            if event.key == pygame.K_p:
                frame = frame_read.frame
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"{IMAGE_DIR}/tello_{timestamp}.jpg"
                cv2.imwrite(filename, frame)
                print(f"Photo saved: {filename}")

    keys = pygame.key.get_pressed()

    # ×ª× ×•×¢×”
    lr = fb = ud = yaw = 0

    if keys[pygame.K_w]:
        fb = SPEED
    elif keys[pygame.K_s]:
        fb = -SPEED

    if keys[pygame.K_a]:
        lr = -SPEED
    elif keys[pygame.K_d]:
        lr = SPEED

    if keys[pygame.K_UP]:
        ud = SPEED
    elif keys[pygame.K_DOWN]:
        ud = -SPEED

    if keys[pygame.K_LEFT]:
        yaw = -SPEED
    elif keys[pygame.K_RIGHT]:
        yaw = SPEED

    tello.send_rc_control(lr, fb, ud, yaw)

# ---------- ×¡×™×•× ×‘×˜×•×— ----------
tello.streamoff()
pygame.quit()
print("Controller closed safely")
